<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="/favicon.png" />
  <title>Inspection Report ‚Äî InspectAI</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      min-height: 100vh;
      background: linear-gradient(to bottom, #0a1020 0%, #070b14 50%, #000 100%);
      color: #fff;
      font-family: system-ui, -apple-system, sans-serif;
      line-height: 1.6;
    }
    .container {
      max-width: 640px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }
    header {
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 1.25rem;
      margin-bottom: 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.75rem;
    }
    header h1 {
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: #fff;
    }
    .header-badge {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.8rem;
      color: rgba(251,191,36,0.95);
    }
    .header-badge::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: rgba(251,191,36,0.8);
    }
    .card {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 1.25rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4), 0 0 0 1px rgba(0,0,0,0.2);
      transition: box-shadow 0.2s, transform 0.15s;
    }
    .card:hover { box-shadow: 0 8px 28px rgba(0,0,0,0.5), 0 0 0 1px rgba(0,0,0,0.2); }
    .card.summary { border-left: 3px solid rgba(255,255,255,0.2); }
    .card.overview { border-left: 3px solid rgba(255,255,255,0.15); }
    .card.findings { border-left: 3px solid rgba(251,191,36,0.5); }
    .card.why-it-matters { border-left: 3px solid rgba(248,113,113,0.5); }
    .card.next-steps { border-left: 3px solid rgba(96,165,250,0.5); }
    .card.photos { border-left: 3px solid rgba(255,255,255,0.2); }
    .card-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: rgba(255,255,255,0.95);
    }
    .card-body {
      font-size: 0.9375rem;
      color: rgba(255,255,255,0.85);
      line-height: 1.6;
    }
    .card-body h1, .card-body h2, .card-body h3 {
      margin-top: 1rem;
      margin-bottom: 0.4rem;
    }
    .card-body h1:first-child, .card-body h2:first-child, .card-body h3:first-child { margin-top: 0; }
    .card-body p { margin-bottom: 0.6rem; }
    .card-body ul, .card-body ol {
      margin: 0.6rem 0 0.6rem 1.25rem;
      padding-left: 0.5rem;
    }
    .card-body li { margin-bottom: 0.35rem; }
    .card-body ul:first-child, .card-body ol:first-child { margin-top: 0; }
    .card-body strong { font-weight: 600; color: rgba(255,255,255,0.95); }
    .section-divider {
      height: 1px;
      background: rgba(255,255,255,0.08);
      margin: 2rem 0 1.25rem;
    }
    .photos-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      color: rgba(255,255,255,0.95);
    }
    .photos-hint {
      font-size: 0.8rem;
      color: rgba(255,255,255,0.5);
      margin-bottom: 1rem;
    }
    .photos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.75rem;
    }
    .photo-item {
      position: relative;
      border-radius: 0.75rem;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(0,0,0,0.3);
      cursor: pointer;
      transition: transform 0.15s, border-color 0.15s, box-shadow 0.15s;
    }
    .photo-item:hover {
      transform: scale(1.02);
      border-color: rgba(255,255,255,0.3);
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    .photo-item::after {
      content: 'Click to expand';
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      color: rgba(255,255,255,0.9);
      opacity: 0;
      transition: opacity 0.15s;
    }
    .photo-item:hover::after { opacity: 1; }
    .photo-item img {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      display: block;
    }
    .photo-label {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 0.35rem 0.5rem;
      font-size: 0.7rem;
      font-weight: 600;
      color: rgba(255,255,255,0.9);
      background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
    }
    .empty-state {
      color: rgba(255,255,255,0.5);
      font-size: 0.875rem;
      padding: 2rem;
      text-align: center;
    }
    .badge {
      display: inline-block;
      font-size: 0.7rem;
      color: rgba(255,255,255,0.5);
      background: rgba(255,255,255,0.08);
      padding: 0.2rem 0.5rem;
      border-radius: 0.5rem;
      margin-top: 1rem;
    }
    .lightbox {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 100;
      background: rgba(0,0,0,0.92);
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .lightbox.open { display: flex; }
    .lightbox-backdrop { position: absolute; inset: 0; }
    .lightbox-content {
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
    }
    .lightbox-content img {
      max-width: 90vw;
      max-height: 85vh;
      object-fit: contain;
      border-radius: 0.5rem;
    }
    .lightbox-close {
      position: absolute;
      top: -2.5rem;
      right: 0;
      background: transparent;
      border: none;
      color: rgba(255,255,255,0.8);
      font-size: 1rem;
      cursor: pointer;
      padding: 0.25rem;
    }
    .lightbox-close:hover { color: #fff; }
    .lightbox-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 1.25rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s;
    }
    .lightbox-nav:hover { background: rgba(255,255,255,0.2); }
    .lightbox-prev { left: -3rem; }
    .lightbox-next { right: -3rem; }
    .lightbox-caption {
      text-align: center;
      margin-top: 0.75rem;
      font-size: 0.875rem;
      color: rgba(255,255,255,0.8);
    }
    .lightbox-counter {
      font-weight: 600;
      color: rgba(255,255,255,0.6);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Inspection Report</h1>
      <span class="header-badge" id="headerBadge">Attention Recommended</span>
    </header>
    <div id="app">
      <div class="empty-state">Loading report‚Ä¶</div>
    </div>
  </div>
  <script>
    (function() {
      const hash = window.location.hash.slice(1);
      const app = document.getElementById('app');
      const headerBadge = document.getElementById('headerBadge');

      function classifySection(heading) {
        var h = heading.toLowerCase().replace(/\*+/g, '').trim();
        if (/inspection\s*summary|^summary\s*$/.test(h)) return { type: 'summary', heading: 'Inspection Summary' };
        if (/system\s*overview|^overview\s*$/.test(h)) return { type: 'overview', heading: 'System Overview' };
        if (/key\s*findings|^findings\s*$/.test(h)) return { type: 'findings', heading: 'Key Findings' };
        if (/why\s*it\s*matters/.test(h)) return { type: 'why-it-matters', heading: 'Why It Matters' };
        if (/recommended|next\s*steps/.test(h)) return { type: 'next-steps', heading: 'Recommended Next Steps' };
        return { type: 'other', heading: heading.replace(/\*+/g, '').trim() };
      }
      function isSectionHeader(line) {
        var t = line.trim();
        if (!t) return null;
        var m = t.match(/^#{1,3}\s+(.+)$/);
        if (m) return classifySection(m[1]);
        m = t.match(/^\*\*(.+?)\*\*:?\s*$/);
        if (m) return classifySection(m[1]);
        m = t.match(/^\*\*(.+?)\*\*:?\s/);
        if (m) return classifySection(m[1]);
        if (/^(inspection\s*summary|summary|system\s*overview|overview|key\s*findings|findings|why\s*it\s*matters|recommended\s*next\s*steps|next\s*steps)$/i.test(t)) return classifySection(t);
        return null;
      }
      function extractSections(text) {
        var parts = [];
        var lines = text.split('\n');
        var current = { type: 'summary', heading: 'Inspection Summary', content: '' };
        for (var i = 0; i < lines.length; i++) {
          var parsed = isSectionHeader(lines[i]);
          if (parsed) {
            if (current.content.trim()) parts.push(current);
            current = { type: parsed.type, heading: parsed.heading, content: '' };
          } else {
            current.content += (current.content ? '\n' : '') + lines[i];
          }
        }
        if (current.content.trim()) parts.push(current);
        if (parts.length === 0 && text.trim()) {
          parts.push({ type: 'summary', heading: 'Inspection Summary', content: text });
        }
        if (parts.length === 1 && text.includes('System Overview')) {
          var fallback = [];
          var regex = /(?:\n|^)\s*(System Overview|Key Findings|Why It Matters|Recommended Next Steps|Next Steps)\s*\n/gi;
          var lastIdx = 0;
          var lastType = 'summary';
          var lastHeading = 'Inspection Summary';
          var match;
          while ((match = regex.exec(text)) !== null) {
            var chunk = text.slice(lastIdx, match.index).trim();
            if (chunk) fallback.push({ type: lastType, heading: lastHeading, content: chunk });
            var h = match[1].toLowerCase();
            if (/system\s*overview/.test(h)) { lastType = 'overview'; lastHeading = 'System Overview'; }
            else if (/key\s*findings|findings/.test(h)) { lastType = 'findings'; lastHeading = 'Key Findings'; }
            else if (/why\s*it\s*matters/.test(h)) { lastType = 'why-it-matters'; lastHeading = 'Why It Matters'; }
            else if (/recommended|next\s*steps/.test(h)) { lastType = 'next-steps'; lastHeading = 'Recommended Next Steps'; }
            lastIdx = regex.lastIndex;
          }
          if (lastIdx < text.length) {
            var tail = text.slice(lastIdx).trim();
            if (tail) fallback.push({ type: lastType, heading: lastHeading, content: tail });
          }
          if (fallback.length > 1) return fallback;
        }
        return parts;
      }

      if (!hash) {
        app.innerHTML = '<div class="empty-state">No report data. Share from the InspectAI app.</div>';
        headerBadge.style.display = 'none';
        return;
      }

      try {
        const json = decodeURIComponent(escape(atob(hash)));
        const data = JSON.parse(json);
        const reportText = data.reportText || data.summary || '';
        const photos = data.photos || data.photoAnalysis || [];
        const usablePhotos = photos.filter(function(p) { return p && (p.publicUrl || p.localUrl); });

        const icons = {
          summary: 'üìã',
          overview: 'üß∞',
          findings: 'üîç',
          'why-it-matters': '‚ö†Ô∏è',
          'next-steps': 'üõ†',
          photos: 'üì∑',
          other: 'üìÑ'
        };

        const sections = extractSections(reportText || '');

        let html = '';
        sections.forEach(function(s) {
          html += '<div class="card ' + s.type + '">';
          html += '<div class="card-header">' + (icons[s.type] || icons.other) + ' ' + s.heading + '</div>';
          html += '<div class="card-body">' + marked.parse(s.content || '_No content._') + '</div>';
          html += '</div>';
        });

        if (usablePhotos.length > 0) {
          html += '<div class="section-divider"></div>';
          html += '<div class="card photos">';
          html += '<div class="photos-header">' + icons.photos + ' Visual Documentation</div>';
          html += '<p class="photos-hint">Click any image to expand.</p>';
          html += '<div class="photos-grid">';
          usablePhotos.forEach(function(p, i) {
            const url = p.publicUrl || p.localUrl;
            var caption = p.caption || p.filename || '';
            if (typeof caption === 'string' && (caption.startsWith('{') || caption.length > 60)) caption = '';
            const shortCaption = caption ? (caption.length > 40 ? caption.slice(0, 37) + '‚Ä¶' : caption) : '';
            const safeUrl = url.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            const safeCaption = (p.caption || p.filename || 'Photo').replace(/</g, '&lt;').replace(/"/g, '&quot;');
            html += '<div class="photo-item" data-idx="' + i + '" role="button" tabindex="0" title="Click to expand">';
            html += '<img src="' + safeUrl + '" alt="' + safeCaption + '" loading="lazy">';
            html += '<span class="photo-label">Photo ' + (i + 1) + (shortCaption ? ' ‚Äî ' + shortCaption : '') + '</span>';
            html += '</div>';
          });
          html += '</div></div>';
        }

        html += '<span class="badge">Generated by InspectAI</span>';
        app.innerHTML = html;

        if (usablePhotos.length > 0) {
          const lightbox = document.createElement('div');
          lightbox.className = 'lightbox';
          lightbox.innerHTML = '<div class="lightbox-backdrop"></div>' +
            '<div class="lightbox-content">' +
            '<button type="button" class="lightbox-close">‚úï Close</button>' +
            (usablePhotos.length > 1 ? '<button type="button" class="lightbox-nav lightbox-prev">‚Äπ</button><button type="button" class="lightbox-nav lightbox-next">‚Ä∫</button>' : '') +
            '<img src="" alt="">' +
            '<div class="lightbox-caption"><span class="lightbox-counter"></span></div>' +
            '</div>';
          document.body.appendChild(lightbox);

          let idx = 0;
          const lbImg = lightbox.querySelector('.lightbox-content img');
          const lbCaption = lightbox.querySelector('.lightbox-caption');
          const lbPrev = lightbox.querySelector('.lightbox-prev');
          const lbNext = lightbox.querySelector('.lightbox-next');

          function showImg(i) {
            idx = (i + usablePhotos.length) % usablePhotos.length;
            const p = usablePhotos[idx];
            lbImg.src = p.publicUrl || p.localUrl;
            lbCaption.innerHTML = '<span class="lightbox-counter">' + (idx + 1) + ' / ' + usablePhotos.length + '</span>' +
              (p.caption || p.filename ? ' ‚Ä¢ ' + (p.caption || p.filename) : '');
          }

          function openLb(i) {
            idx = i;
            showImg(idx);
            lightbox.classList.add('open');
          }

          function closeLb() {
            lightbox.classList.remove('open');
          }

          lightbox.querySelector('.lightbox-backdrop').onclick = closeLb;
          lightbox.querySelector('.lightbox-close').onclick = closeLb;
          if (lbPrev) lbPrev.onclick = function(e) { e.stopPropagation(); showImg(idx - 1); };
          if (lbNext) lbNext.onclick = function(e) { e.stopPropagation(); showImg(idx + 1); };

          document.querySelectorAll('.photo-item').forEach(function(el) {
            el.onclick = function() { openLb(parseInt(el.dataset.idx, 10)); };
            el.onkeydown = function(e) {
              if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openLb(parseInt(el.dataset.idx, 10)); }
            };
          });

          document.addEventListener('keydown', function(e) {
            if (!lightbox.classList.contains('open')) return;
            if (e.key === 'Escape') closeLb();
            if (e.key === 'ArrowLeft' && lbPrev) { e.preventDefault(); showImg(idx - 1); }
            if (e.key === 'ArrowRight' && lbNext) { e.preventDefault(); showImg(idx + 1); }
          });
        }
      } catch (e) {
        app.innerHTML = '<div class="empty-state">Invalid or expired report link.</div>';
        headerBadge.style.display = 'none';
      }
    })();
  </script>
</body>
</html>
